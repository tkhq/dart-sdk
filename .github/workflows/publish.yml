name: Publish Package

on:
  workflow_dispatch: # triggered by version-and-publish workflow on each package tag

permissions:
  contents: read
  id-token: write # required for trusted publishers (OIDC)

jobs:
  publish:
    runs-on: package-deploy

    steps:
      - name: Validate caller
        run: |
          if [[ "${{ github.triggering_actor }}" != "github-actions[bot]" ]]; then
            echo "Error: workflow must be triggered by github-actions[bot], got: ${{ github.triggering_actor }}"
            exit 1
          fi
          echo "Caller validated: ${{ github.triggering_actor }}"

      - name: Parse package info from tag
        id: parse
        run: |
          TAG="${GITHUB_REF#refs/tags/}"
          # Extract package name (everything before the last dash followed by version)
          PKG_NAME=$(echo "$TAG" | sed -E 's/-[0-9]+\.[0-9]+\.[0-9]+$//')
          VERSION=$(echo "$TAG" | sed -E 's/.*-([0-9]+\.[0-9]+\.[0-9]+)$/\1/')
          echo "tag=$TAG" >> $GITHUB_OUTPUT
          echo "package=$PKG_NAME" >> $GITHUB_OUTPUT
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Parsed: package=$PKG_NAME, version=$VERSION"

      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          ref: ${{ github.ref }}

      - name: Setup Dart
        uses: dart-lang/setup-dart@e51d8e571e22473a2ddebf0ef8a2123f0ab2c02c # v1.7.1

      - name: Install dependencies
        run: dart pub get
        working-directory: packages/${{ steps.parse.outputs.package }}

      - name: Verify package version matches tag
        run: |
          PUBSPEC_VERSION=$(grep -E "^version:" pubspec.yaml | sed 's/version: *//')
          if [ "$PUBSPEC_VERSION" != "${{ steps.parse.outputs.version }}" ]; then
            echo "Version mismatch: pubspec.yaml has $PUBSPEC_VERSION but tag is ${{ steps.parse.outputs.version }}"
            exit 1
          fi
          echo "Version verified: $PUBSPEC_VERSION"
        working-directory: packages/${{ steps.parse.outputs.package }}

      - name: Publish to pub.dev (dry run)
        run: dart pub publish --dry-run
        working-directory: packages/${{ steps.parse.outputs.package }}

      - name: Publish to pub.dev
        run: dart pub publish --force
        working-directory: packages/${{ steps.parse.outputs.package }}
