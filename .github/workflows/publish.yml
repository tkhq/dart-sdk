name: Publish Package

on:
  workflow_dispatch: # triggered by version-and-publish workflow on each package tag

permissions:
  contents: read
  id-token: write # required for trusted publishers (OIDC)

jobs:
  publish:
    runs-on: package-deploy

    steps:
      - name: Validate caller
        run: |
          if [[ "${{ github.triggering_actor }}" != "github-actions[bot]" ]]; then
            echo "Error: workflow must be triggered by github-actions[bot], got: ${{ github.triggering_actor }}"
            exit 1
          fi
          echo "Caller validated: ${{ github.triggering_actor }}"

      - name: Parse package info from tag
        id: parse
        run: |
          TAG="${GITHUB_REF#refs/tags/}"
          # Extract package name (everything before the last dash followed by version)
          PKG_NAME=$(echo "$TAG" | sed -E 's/-[0-9]+\.[0-9]+\.[0-9]+$//')
          VERSION=$(echo "$TAG" | sed -E 's/.*-([0-9]+\.[0-9]+\.[0-9]+)$/\1/')
          echo "tag=$TAG" >> $GITHUB_OUTPUT
          echo "package=$PKG_NAME" >> $GITHUB_OUTPUT
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Parsed: package=$PKG_NAME, version=$VERSION"

      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          ref: ${{ github.ref }}

      - name: Resolve package directory
        id: resolve-dir
        run: |
          PKG_DIR=$(grep -rl "^name: ${{ steps.parse.outputs.package }}$" packages/*/pubspec.yaml | head -1 | xargs dirname)
          if [ -z "$PKG_DIR" ]; then
            echo "::error::Could not find directory for package ${{ steps.parse.outputs.package }}"
            exit 1
          fi
          echo "dir=$PKG_DIR" >> $GITHUB_OUTPUT
          echo "Resolved directory: $PKG_DIR"

      - name: Setup Flutter
        uses: subosito/flutter-action@e938fdf56512cc96ef2f93601a5a40bde3801046 # v2.19.0
        with:
          channel: stable

      - name: Install dependencies
        run: flutter pub get

      - name: Verify package version matches tag
        run: |
          PUBSPEC_VERSION=$(grep -E "^version:" pubspec.yaml | sed 's/version: *//')
          if [ "$PUBSPEC_VERSION" != "${{ steps.parse.outputs.version }}" ]; then
            echo "Version mismatch: pubspec.yaml has $PUBSPEC_VERSION but tag is ${{ steps.parse.outputs.version }}"
            exit 1
          fi
          echo "Version verified: $PUBSPEC_VERSION"
        working-directory: ${{ steps.resolve-dir.outputs.dir }}

      - name: Authenticate to pub.dev (OIDC)
        run: |
          OIDC_TOKEN=$(curl -sLS "${ACTIONS_ID_TOKEN_REQUEST_URL}&audience=https://pub.dev" \
            -H "User-Agent: actions/oidc-client" \
            -H "Authorization: Bearer ${ACTIONS_ID_TOKEN_REQUEST_TOKEN}" \
            | jq -r '.value')
          echo "PUB_TOKEN=${OIDC_TOKEN}" >> $GITHUB_ENV
          dart pub token add https://pub.dev --env-var PUB_TOKEN

      - name: Publish to pub.dev (dry run)
        run: dart pub publish --dry-run
        working-directory: ${{ steps.resolve-dir.outputs.dir }}

      - name: Publish to pub.dev
        run: dart pub publish --force
        working-directory: ${{ steps.resolve-dir.outputs.dir }}